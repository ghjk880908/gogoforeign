<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥åœ‹å¤–æ—…éŠå ±å - GoGoforeign é€£ç·šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- å¼•å…¥ EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, addDoc, deleteDoc, getDocs, doc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      window.firebaseModules = { initializeApp, getAnalytics, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, deleteDoc, getDocs, doc, onSnapshot, query, where, orderBy, serverTimestamp };
    </script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;500&display=swap');
      body { font-family: 'Noto Sans TC', sans-serif; background-color: #f7fcfc; }
      h1, h2, h3, .font-serif { font-family: 'Noto Serif TC', serif; }
      .custom-scrollbar::-webkit-scrollbar { width: 5px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      .animate-blob { animation: blob 7s infinite; }
      @keyframes blob { 0% { transform: translate(0px, 0px) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0px, 0px) scale(1); } }
      .loader { border: 3px solid #f3f3f3; border-top: 3px solid #2dd4bf; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
      input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
      
      /* è®“å¤ªé™½åœ–ç¤ºå¯ä»¥è¢«é»æ“Šï¼Œä½†ä¸æ˜é¡¯ */
      .secret-btn { cursor: default; }
      .secret-btn:active { transform: scale(0.95); }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;
      
      // --- è¨­å®šå€ ---
      const firebaseConfig = {
        apiKey: "AIzaSyAJxDWoLScisNwqwi6ubdPIKY3h6JgHoaE",
        authDomain: "gogoforeign-fd349.firebaseapp.com",
        projectId: "gogoforeign-fd349",
        storageBucket: "gogoforeign-fd349.firebasestorage.app",
        messagingSenderId: "797516696198",
        appId: "1:797516696198:web:656f90ddbaac253e0adf07",
        measurementId: "G-2YMPJYDN3T"
      };

      // EmailJS è¨­å®š
      const EMAILJS_SERVICE_ID = "service_y4dg7oa"; 
      const EMAILJS_TEMPLATE_ID = "template_j4vrctu"; 
      const EMAILJS_PUBLIC_KEY = "xvLWfRBCl10S7_Fr2";   

      const Icons = {
        Plane: () => <svg className="w-12 h-12 text-blue-600 transform -rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>,
        Building: ({className}) => <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>,
        Luggage: ({className}) => <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12V7a2 2 0 00-2-2H5a2 2 0 00-2 2v5m18 0v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5m18 0h-2a2 2 0 01-2 2H9a2 2 0 01-2-2H3m3-5v-2a2 2 0 012-2h8a2 2 0 012 2v2"></path></svg>,
        Users: ({className}) => <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>,
        Sun: ({className}) => <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>,
        CheckCircle: ({className}) => <svg className={className || "w-16 h-16"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
        User: ({className}) => <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>,
        Mail: ({className}) => <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>,
        Phone: ({className}) => <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>,
        AlertCircle: ({className}) => <svg className={className || "w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
        MapPin: ({className}) => <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>,
        Download: ({className}) => <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>,
      };

      function App() {
        const REGION_CAPACITY = 40;
        const IS_PAUSED = false; 
        
        const SITES = [
          "å°åŒ—ä¸€æœŸ - åŸºç¤å·¥ç¨‹",
          "å°ä¸­äºŒæœŸ - çµæ§‹é«”",
          "å°å—ä¸‰æœŸ - è£ä¿®å·¥ç¨‹",
          "é«˜é›„å››æœŸ - æ©Ÿé›»å·¥ç¨‹",
          "ç¸½å…¬å¸ - è¡Œæ”¿éƒ¨",
          "å…¶ä»–"
        ];

        const TRAVEL_REGIONS = [
          "æ—¥æœ¬ - åŒ—æµ·é“",
          "æ—¥æœ¬ - æ±äº¬",
          "éŸ“åœ‹ - é¦–çˆ¾",
          "æ³°åœ‹ - æ›¼è°·",
          "è¶Šå— - å³´æ¸¯"
        ];

        const [firebaseInitialized, setFirebaseInitialized] = useState(false);
        const [user, setUser] = useState(null);
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [isConfigured, setIsConfigured] = useState(false);

        // åˆå§‹åŒ– EmailJS
        useEffect(() => {
          if (EMAILJS_PUBLIC_KEY !== "YOUR_EMAILJS_PUBLIC_KEY") {
            emailjs.init(EMAILJS_PUBLIC_KEY);
          }
        }, []);

        useEffect(() => {
          const init = () => {
            if (window.firebaseModules) {
              const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, getAnalytics } = window.firebaseModules;
              
              if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                setIsConfigured(false);
                setLoading(false);
                return;
              }

              try {
                const app = initializeApp(firebaseConfig);
                const authInstance = getAuth(app);
                const dbInstance = getFirestore(app);
                if (typeof getAnalytics === 'function') getAnalytics(app);
                
                setAuth(authInstance);
                setDb(dbInstance);
                setIsConfigured(true);

                signInAnonymously(authInstance)
                  .then(() => {
                    onAuthStateChanged(authInstance, (u) => {
                      setUser(u);
                      setFirebaseInitialized(true);
                    });
                  })
                  .catch((e) => {
                    console.error("Auth Error:", e);
                    alert("Firebase é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ˜¯å¦å·²é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ã€");
                  });

              } catch (e) {
                console.error("Firebase Init Error:", e);
                alert("Firebase é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Config");
              }
            }
          };
          init();
        }, []);

        const [registrants, setRegistrants] = useState([]);
        const [loading, setLoading] = useState(true);
        const [selectedRegionFilter, setSelectedRegionFilter] = useState(TRAVEL_REGIONS[0]);

        const [form, setForm] = useState({
          name: '', site: '', region: '', email: '', phone: '', 
          hasCompanion: 'false', companionCount: 0, companions: []
        });
        const [submitting, setSubmitting] = useState(false);
        const [submitted, setSubmitted] = useState(false);

        // æ©Ÿé—œï¼šè¨ˆç®—é»æ“Šæ¬¡æ•¸
        const [secretClickCount, setSecretClickCount] = useState(0);
        const clickTimeoutRef = useRef(null);

        useEffect(() => {
           if (!user || !db) return;
           const { collection, onSnapshot, query } = window.firebaseModules;
           const q = query(collection(db, 'travel_registrations'));

           const unsubscribe = onSnapshot(q, (snapshot) => {
             const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             data.sort((a, b) => {
                const timeA = (a.createdAt && a.createdAt.seconds) ? a.createdAt.seconds : 0;
                const timeB = (b.createdAt && b.createdAt.seconds) ? b.createdAt.seconds : 0;
                return timeB - timeA;
             });
             setRegistrants(data);
             setLoading(false);
           }, (error) => {
             console.error("Fetch Error:", error);
             if (error.code === 'permission-denied') alert("è®€å–è³‡æ–™å¤±æ•—ï¼šè«‹æª¢æŸ¥ Firebase Rules æ˜¯å¦ç‚º allow read, write: if true;");
             setLoading(false);
           });
           return () => unsubscribe();
        }, [user, db]);

        const getRegionCount = (regionName) => {
          return registrants
            .filter(r => r.region === regionName)
            .reduce((acc, curr) => acc + curr.totalCount, 0);
        };

        const currentRegionCount = getRegionCount(form.region);
        const isCurrentRegionFull = form.region && currentRegionCount >= REGION_CAPACITY;

        const handleChange = (e) => {
          const { name, value } = e.target;
          setForm(prev => ({ ...prev, [name]: value }));
        };

        const handleCompanionToggle = (val) => {
          const isChecked = val === 'true';
          setForm(prev => {
            if (!isChecked) return { ...prev, hasCompanion: 'false', companionCount: 0, companions: [] };
            return { ...prev, hasCompanion: 'true', companionCount: 1, companions: [{name: '', phone: ''}] };
          });
        };

        const handleCompanionCountChange = (val) => {
          let count = parseInt(val);
          if (isNaN(count) || count < 1) count = 1;
          setForm(prev => {
            let newCompanions = [...prev.companions];
            if (count > prev.companions.length) {
              for(let i=0; i < count - prev.companions.length; i++) newCompanions.push({ name: '', phone: '' });
            } else {
              newCompanions = newCompanions.slice(0, count);
            }
            return { ...prev, companionCount: count, companions: newCompanions };
          });
        };

        const handleCompanionDataChange = (index, field, value) => {
          setForm(prev => {
            const newCompanions = [...prev.companions];
            newCompanions[index] = { ...newCompanions[index], [field]: value };
            return { ...prev, companions: newCompanions };
          });
        };

        // ç™¼é€ Email (å¢å¼·éŒ¯èª¤æç¤ºç‰ˆ)
        const sendConfirmationEmail = (data) => {
          if (EMAILJS_PUBLIC_KEY === "YOUR_EMAILJS_PUBLIC_KEY") {
            console.warn("EmailJS æœªè¨­å®šï¼Œè·³éå¯„ä¿¡æ­¥é©Ÿ");
            return;
          }
          
          const templateParams = {
            to_name: data.name,
            to_email: data.email,
            region: data.region,
            site: data.site,
            total_count: data.totalCount,
            companion_info: data.hasCompanion === 'true' ? `æ”œå¸¶çœ·å±¬ ${data.companionCount} ä½` : 'ç„¡æ”œå¸¶çœ·å±¬'
          };

          emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
            .then((response) => {
               console.log('Email Sent!', response.status, response.text);
            }, (err) => {
               console.error('Email Failed...', err);
               if (err.status === 422) {
                 alert("ä¿¡ä»¶ç™¼é€å¤±æ•—ï¼šEmail æ ¼å¼éŒ¯èª¤æˆ–æ¨¡æ¿è¨­å®šæœ‰èª¤ (422 Unprocessable Entity)ã€‚è«‹æª¢æŸ¥ EmailJS å¾Œå° 'To Email' æ˜¯å¦è¨­å®šç‚º {{to_email}}");
               } else {
                 alert("ä¿¡ä»¶ç™¼é€å¤±æ•— (Code " + err.status + "): " + err.text);
               }
            });
        };

        // åŒ¯å‡º CSV åŠŸèƒ½
        const handleExportCSV = () => {
          if (registrants.length === 0) {
            alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
            return;
          }

          // å®šç¾© CSV æ¨™é¡Œ
          const headers = ["å§“å", "åœ°å€", "å·¥åœ°", "Email", "é›»è©±", "æ”œä¼´", "çœ·å±¬äººæ•¸", "çœ·å±¬è³‡æ–™", "ç¸½äººæ•¸", "å ±åæ™‚é–“"];
          
          // è½‰æ›è³‡æ–™ç‚º CSV æ ¼å¼
          const csvRows = [
            headers.join(','), // æ¨™é¡Œåˆ—
            ...registrants.map(r => {
              // è™•ç†çœ·å±¬è³‡æ–™ï¼šè½‰æ›æˆå­—ä¸²
              let companionsStr = "";
              if (r.hasCompanion === 'true' && Array.isArray(r.companions) && r.companions.length > 0) {
                companionsStr = r.companions.map(c => `${c.name}(${c.phone})`).join('; ');
              }

              // è™•ç†æ¯å€‹æ¬„ä½ï¼Œç¢ºä¿é€—è™Ÿä¸æœƒç ´å£æ ¼å¼ï¼Œä¸¦è™•ç†é›»è©±è™Ÿç¢¼
              const row = [
                `"${r.name}"`,
                `"${r.region}"`,
                `"${r.site}"`,
                `"${r.email}"`,
                `'${r.phone}`, // åŠ å–®å¼•è™Ÿé¿å… Excel è®Šæ•¸å­—
                `"${r.hasCompanion === 'true' ? 'æ˜¯' : 'å¦'}"`,
                `"${r.companionCount || 0}"`,
                `"${companionsStr}"`, // æ–°å¢çš„çœ·å±¬è©³ç´°è³‡æ–™æ¬„ä½
                `"${r.totalCount}"`,
                `"${r.timestamp}"`
              ];
              return row.join(',');
            })
          ];

          // çµ„åˆä¸¦ä¸‹è¼‰
          const csvString = "\uFEFF" + csvRows.join('\n'); // åŠ ä¸Š BOM è§£æ±ºä¸­æ–‡äº‚ç¢¼
          const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `GoGoForeign_List_${new Date().toISOString().slice(0,10)}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        // ç§˜å¯†æ©Ÿé—œï¼šé€£çºŒé»æ“Šå¤ªé™½åœ–ç¤º
        const handleSecretClick = () => {
          setSecretClickCount(prev => {
            const newCount = prev + 1;
            if (clickTimeoutRef.current) clearTimeout(clickTimeoutRef.current);
            clickTimeoutRef.current = setTimeout(() => setSecretClickCount(0), 1000); // 1ç§’å…§æ²’é»å°±é‡ç½®

            if (newCount === 5) {
              alert("ğŸ¤« ç®¡ç†å“¡æ¨¡å¼å•Ÿå‹•ï¼šæ­£åœ¨åŒ¯å‡ºå ±åè³‡æ–™...");
              handleExportCSV();
              return 0;
            }
            return newCount;
          });
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          if (IS_PAUSED) { alert("ç›®å‰æš«åœå—ç†å ±å"); return; }
          if (!user) { alert("ç³»çµ±é€£ç·šä¸­ï¼Œè«‹ç¨å¾Œ"); return; }
          
          if (!form.site) { alert("è«‹é¸æ“‡å·¥åœ°"); return; }
          if (!form.region) { alert("è«‹é¸æ“‡æ—…éŠåœ°å€"); return; }
          
          if (form.hasCompanion === 'true') {
            for (let i = 0; i < form.companions.length; i++) {
                if (!form.companions[i].name.trim() || !form.companions[i].phone.trim()) {
                    alert(`è«‹å®Œæ•´å¡«å¯«ç¬¬ ${i+1} ä½çœ·å±¬çš„å§“åèˆ‡é›»è©±`);
                    return;
                }
            }
          }
          
          const thisCount = 1 + (form.hasCompanion === 'true' ? parseInt(form.companionCount || 0) : 0);
          
          if (getRegionCount(form.region) + thisCount > REGION_CAPACITY) {
            alert(`å¾ˆæŠ±æ­‰ï¼Œ${form.region} åé¡å·²æ»¿ï¼è«‹é¸æ“‡å…¶ä»–è¡Œç¨‹ã€‚`);
            return;
          }

          setSubmitting(true);

          const { addDoc, deleteDoc, getDocs, collection, query, where, serverTimestamp } = window.firebaseModules;
          const registrationsRef = collection(db, 'travel_registrations');

          // 1. æŸ¥è©¢æ˜¯å¦æœ‰èˆŠè³‡æ–™ (ä¾ç…§ Phone)
          const q = query(registrationsRef, where("phone", "==", form.phone));

          getDocs(q)
            .then((querySnapshot) => {
              const deletePromises = [];
              querySnapshot.forEach((doc) => {
                console.log("ç™¼ç¾èˆŠè³‡æ–™ï¼Œæº–å‚™åˆªé™¤:", doc.id, doc.data().region);
                deletePromises.push(deleteDoc(doc.ref));
              });
              return Promise.all(deletePromises);
            })
            .then(() => {
              // 2. èˆŠè³‡æ–™åˆªé™¤å®Œç•¢ï¼Œæ–°å¢æ–°è³‡æ–™
              return addDoc(registrationsRef, {
                name: form.name,
                site: form.site,
                region: form.region,
                email: form.email,
                phone: form.phone,
                hasCompanion: form.hasCompanion,
                companionCount: thisCount - 1, 
                // ğŸ”¥ ä¿®æ­£ï¼šå°‡çœ·å±¬è©³ç´°åå–®å­˜å…¥è³‡æ–™åº«
                companions: form.hasCompanion === 'true' ? form.companions : [],
                totalCount: thisCount,
                timestamp: new Date().toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }),
                createdAt: serverTimestamp()
              });
            })
            .then(() => {
              // 3. æˆåŠŸï¼å¯„ä¿¡ & æ›´æ–° UI
              sendConfirmationEmail({
                name: form.name,
                email: form.email,
                region: form.region,
                site: form.site,
                totalCount: thisCount,
                hasCompanion: form.hasCompanion,
                companionCount: form.companionCount
              });

              setSubmitting(false);
              setSubmitted(true);
              setSelectedRegionFilter(form.region);
            })
            .catch((error) => {
              console.error("Error processing registration: ", error);
              alert("å ±åå¤±æ•—: " + error.message);
              setSubmitting(false);
            });
        };

        if (submitted) {
          return (
            <div className="min-h-screen bg-[#fdfbf7] flex items-center justify-center p-4 relative overflow-hidden">
               <div className="absolute top-0 left-0 w-96 h-96 bg-teal-200 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob"></div>
               <div className="absolute bottom-0 right-0 w-96 h-96 bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob animation-delay-2000"></div>
               <div className="bg-white/60 backdrop-blur-xl p-10 rounded-3xl shadow-2xl border border-white/40 max-w-md w-full text-center relative z-10">
                 <div className="flex justify-center mb-6"><div className="bg-teal-100 p-4 rounded-full shadow-inner"><Icons.CheckCircle className="text-teal-600" /></div></div>
                 <h2 className="text-3xl font-serif font-bold text-teal-900 mb-2">å ±åæˆåŠŸ</h2>
                 <p className="text-teal-700 mb-4 text-lg font-medium">æ‚¨å·²æˆåŠŸå ±å {form.region} è¡Œç¨‹ï¼</p>
                 <p className="text-slate-500 mb-8 text-sm">ç³»çµ±å·²è‡ªå‹•æ›´æ–°æ‚¨çš„æœ€æ–°é¸æ“‡ï¼Œä¸¦ç™¼é€ç¢ºèªä¿¡è‡³æ‚¨çš„ä¿¡ç®±ã€‚</p>
                 <button onClick={() => {
                    setSubmitted(false);
                    setForm({ name: '', site: '', region: '', email: '', phone: '', hasCompanion: 'false', companionCount: 0, companions: [] });
                 }} className="w-full bg-gradient-to-r from-teal-500 to-blue-600 text-white px-6 py-3 rounded-xl font-serif font-bold hover:shadow-lg transition">è¿”å›é¦–é </button>
               </div>
            </div>
          );
        }

        if (!isConfigured) {
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-800 text-white p-8">
                    <div className="max-w-2xl text-center space-y-6">
                        <h1 className="text-3xl font-bold text-teal-400">ğŸš€ æº–å‚™é€£æ¥ GoGoforeign</h1>
                        <p className="text-slate-400">è«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„ API Key è¨­å®šã€‚</p>
                    </div>
                </div>
            );
        }

        if (!firebaseInitialized || loading) return <div className="min-h-screen flex items-center justify-center bg-[#f7fcfc]"><div className="loader"></div></div>;

        return (
          <div className="min-h-screen bg-[#f7fcfc] py-8 px-4 sm:px-6 lg:px-8 font-sans relative overflow-hidden">
            <div className="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
               <div className="absolute top-[-10%] left-[-10%] w-[60%] h-[60%] bg-teal-200/60 rounded-full blur-[80px] mix-blend-multiply animate-pulse"></div>
               <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-blue-200/60 rounded-full blur-[80px] mix-blend-multiply animate-pulse" style={{animationDelay: '1s'}}></div>
               <div className="absolute top-[30%] right-[30%] w-[40%] h-[40%] bg-purple-200/50 rounded-full blur-[60px] mix-blend-multiply animate-pulse" style={{animationDelay: '2s'}}></div>
            </div>

            <div className="max-w-6xl mx-auto space-y-8">
              <div className="bg-gradient-to-br from-white/60 to-teal-50/60 backdrop-blur-xl rounded-3xl shadow-xl overflow-hidden border border-white/50 relative">
                <div className="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-teal-400 via-blue-400 to-indigo-400"></div>
                <div className="p-8 md:p-10 text-center">
                  <div className="flex justify-center mb-4"><div className="bg-blue-100/80 p-4 rounded-full shadow-md"><Icons.Plane /></div></div>
                  <h1 className="text-4xl md:text-5xl font-serif font-black text-teal-900 mb-3 tracking-wide">å“¡å·¥åœ‹å¤–æ—…éŠå ±å</h1>
                  <p className="text-teal-700 text-lg font-medium">å…¬å‘Šæ–‡å­—</p>
                </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div className="lg:col-span-6 xl:col-span-5">
                  <div className="bg-gradient-to-b from-white/80 to-blue-50/80 backdrop-blur-md rounded-3xl shadow-lg p-8 border border-white/60 h-full relative overflow-hidden">
                    <div className="flex items-center justify-between mb-8 relative z-10">
                        <div className="flex items-center gap-3">
                           <div className="p-3 bg-indigo-100 rounded-xl text-indigo-600 shadow-sm"><Icons.Luggage /></div>
                           <h2 className="text-2xl font-serif font-bold text-slate-800">å¡«å¯«å ±åè³‡è¨Š</h2>
                        </div>
                        {IS_PAUSED && <div className="flex items-center gap-1 text-rose-500 bg-rose-100 px-3 py-1 rounded-full text-sm font-bold">å ±åæš«åœ</div>}
                    </div>
                    
                    <form onSubmit={handleSubmit} className="space-y-6 relative z-10">
                      <fieldset disabled={IS_PAUSED} className={`space-y-6 transition-opacity duration-300 ${IS_PAUSED ? 'opacity-60 grayscale-[50%]' : ''}`}>
                          <div className="group">
                             <label className="block text-sm font-bold text-slate-700 mb-1 ml-1">åƒåŠ è€…å§“å <span className="text-rose-500">*</span></label>
                             <div className="relative">
                               <div className="absolute left-4 top-3.5 text-slate-400"><Icons.User className="w-5 h-5" /></div>
                               <input required name="name" value={form.name} onChange={handleChange} className="w-full pl-12 pr-4 py-3 bg-white/60 border border-white focus:border-blue-300 rounded-xl outline-none transition font-medium placeholder:text-slate-400 disabled:bg-slate-100 disabled:cursor-not-allowed" placeholder="è«‹è¼¸å…¥æ‚¨çš„å…¨å"/>
                             </div>
                          </div>
                          
                          <div className="group">
                             <label className="block text-sm font-bold text-slate-700 mb-1 ml-1">æƒ³å»å“ªè£¡ç©ï¼Ÿ <span className="text-rose-500">*</span></label>
                             <div className="relative">
                                <div className="absolute left-4 top-3.5 text-slate-400"><Icons.MapPin className="w-5 h-5" /></div>
                                <select required name="region" value={form.region} onChange={handleChange} className="w-full pl-12 pr-10 py-3 bg-white/60 border border-white focus:border-blue-300 rounded-xl outline-none transition font-medium cursor-pointer font-sans text-slate-800 disabled:bg-slate-100 disabled:cursor-not-allowed">
                                  <option value="" disabled>è«‹é¸æ“‡æ—…éŠåœ°å€...</option>
                                  {TRAVEL_REGIONS.map((r,i) => {
                                    const count = getRegionCount(r);
                                    const isFull = count >= REGION_CAPACITY;
                                    return <option key={i} value={r} disabled={isFull}>{r} {isFull ? '(é¡æ»¿)' : ''}</option>;
                                  })}
                                </select>
                             </div>
                             {!IS_PAUSED && form.region && (
                               <div className="mt-2 text-xs font-medium ml-1 text-slate-500">
                                 è©²è¡Œç¨‹ç›®å‰å·²å ±å: <span className={isCurrentRegionFull ? 'text-rose-500 font-bold' : 'text-teal-600'}>{currentRegionCount}</span> / {REGION_CAPACITY} äºº
                               </div>
                             )}
                          </div>

                          <div className="group">
                             <label className="block text-sm font-bold text-slate-700 mb-1 ml-1">æ‰€å±¬å·¥åœ° <span className="text-rose-500">*</span></label>
                             <div className="relative">
                                <div className="absolute left-4 top-3.5 text-slate-400"><Icons.Building className="w-5 h-5" /></div>
                                <select required name="site" value={form.site} onChange={handleChange} className="w-full pl-12 pr-10 py-3 bg-white/60 border border-white focus:border-blue-300 rounded-xl outline-none transition font-medium cursor-pointer font-sans text-slate-800 disabled:bg-slate-100 disabled:cursor-not-allowed">
                                  <option value="" disabled>è«‹é¸æ“‡æ‰€å±¬å·¥åœ°...</option>
                                  {SITES.map((s,i)=><option key={i} value={s}>{s}</option>)}
                                </select>
                             </div>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="group">
                              <label className="block text-sm font-bold text-slate-700 mb-1 ml-1">Email <span className="text-rose-500">*</span></label>
                              <div className="relative">
                                 <div className="absolute left-4 top-3.5 text-slate-400"><Icons.Mail className="w-5 h-5" /></div>
                                 <input required name="email" type="email" value={form.email} onChange={handleChange} className="w-full pl-12 pr-4 py-3 bg-white/60 border border-white focus:border-blue-300 rounded-xl outline-none transition font-medium placeholder:text-slate-400 disabled:bg-slate-100 disabled:cursor-not-allowed" placeholder="mail@example.com"/>
                              </div>
                            </div>
                            <div className="group">
                              <label className="block text-sm font-bold text-slate-700 mb-1 ml-1">é›»è©± <span className="text-rose-500">*</span></label>
                              <div className="relative">
                                 <div className="absolute left-4 top-3.5 text-slate-400"><Icons.Phone className="w-5 h-5" /></div>
                                 <input required name="phone" type="tel" value={form.phone} onChange={handleChange} className="w-full pl-12 pr-4 py-3 bg-white/60 border border-white focus:border-blue-300 rounded-xl outline-none transition font-medium placeholder:text-slate-400 disabled:bg-slate-100 disabled:cursor-not-allowed" placeholder="09xx-xxx-xxx"/>
                              </div>
                            </div>
                          </div>
                          <div className="pt-6 border-t border-slate-200/60">
                             <label className={`flex items-center p-4 rounded-2xl bg-[#fff8e1]/60 transition group border border-orange-50 ${IS_PAUSED ? 'cursor-not-allowed opacity-70' : 'cursor-pointer hover:bg-[#fff8e1] hover:border-orange-200'}`}>
                               <div className={`w-6 h-6 rounded-full border-2 mr-4 flex items-center justify-center ${form.hasCompanion === 'true' ? 'bg-orange-500 border-orange-500' : 'bg-white border-slate-300'}`}>{form.hasCompanion === 'true' && <Icons.CheckCircle className="w-4 h-4 text-white"/>}</div><input type="radio" name="hasCompanion" value={form.hasCompanion === 'true' ? 'false' : 'true'} checked={form.hasCompanion === 'true'} onClick={() => !IS_PAUSED && handleCompanionToggle(form.hasCompanion === 'true' ? 'false' : 'true')} className="hidden" disabled={IS_PAUSED}/><span className="text-lg font-serif font-bold text-slate-800">æ˜¯å¦æ”œå¸¶çœ·å±¬ï¼Ÿ</span>
                             </label>
                             {form.hasCompanion === 'true' && (
                               <div className="mt-6 bg-orange-50/60 p-6 rounded-3xl border border-orange-100 space-y-6 animate-fade-in">
                                 <div className="flex items-center gap-4"><label className="text-sm font-bold text-orange-900">çœ·å±¬äººæ•¸</label><div className="flex items-center bg-white/80 rounded-xl shadow-sm w-40 overflow-hidden border border-orange-200"><button type="button" onClick={()=>handleCompanionCountChange(form.companionCount-1)} className="w-12 h-10 font-bold text-orange-600 hover:bg-orange-100" disabled={IS_PAUSED}>-</button><input type="number" min="1" value={form.companionCount} onChange={(e)=>handleCompanionCountChange(e.target.value)} className="w-full text-center font-bold text-orange-800 outline-none bg-transparent" disabled={IS_PAUSED}/><button type="button" onClick={()=>handleCompanionCountChange(form.companionCount+1)} className="w-12 h-10 font-bold text-orange-600 hover:bg-orange-100" disabled={IS_PAUSED}>+</button></div></div>
                                 <div className="space-y-4">{form.companions.map((c,idx)=>(<div key={idx} className="bg-white/90 p-5 rounded-2xl shadow-sm border border-orange-100 flex flex-col md:flex-row gap-4"><div className="w-8 h-8 bg-gradient-to-br from-orange-400 to-pink-400 text-white rounded-full flex items-center justify-center font-bold shrink-0">{idx+1}</div><input required placeholder="å§“å" value={c.name} onChange={(e)=>handleCompanionDataChange(idx,'name',e.target.value)} className="w-full p-2 bg-transparent border-b-2 border-orange-100 focus:border-orange-300 outline-none font-medium" disabled={IS_PAUSED}/><input required placeholder="é›»è©±" value={c.phone} onChange={(e)=>handleCompanionDataChange(idx,'phone',e.target.value)} className="w-full p-2 bg-transparent border-b-2 border-orange-100 focus:border-orange-300 outline-none font-medium" disabled={IS_PAUSED}/></div>))}</div>
                               </div>
                             )}
                          </div>
                      </fieldset>
                      
                      <button type="submit" disabled={submitting || isCurrentRegionFull || IS_PAUSED} className={`w-full py-4 rounded-xl text-white font-serif font-bold text-xl shadow-lg transition-all ${submitting || isCurrentRegionFull || IS_PAUSED ? 'bg-slate-400 cursor-not-allowed' : 'bg-gradient-to-r from-teal-500 to-blue-600 hover:shadow-xl hover:-translate-y-1'}`}>
                        {IS_PAUSED ? 'ç›®å‰æš«åœå—ç†å ±å' : (isCurrentRegionFull ? 'è©²åœ°å€åé¡å·²æ»¿' : (submitting ? 'è™•ç†ä¸­...' : 'ç¢ºèªå ±å'))}
                      </button>
                    </form>
                  </div>
                </div>
                
                <div className="lg:col-span-6 xl:col-span-7">
                  <div className="bg-gradient-to-b from-blue-50/80 to-purple-50/80 backdrop-blur-md rounded-3xl shadow-lg p-6 h-full border border-white/60 flex flex-col relative overflow-hidden">
                    <div className="mb-4 pb-4 border-b border-blue-100/50 relative z-10">
                      <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-3">
                          {/* ç§˜å¯†æ©Ÿé—œæŒ‰éˆ• */}
                          <div onClick={handleSecretClick} className="p-2 bg-teal-100 rounded-lg text-teal-600 shadow-sm secret-btn select-none"><Icons.Sun /></div>
                          <h2 className="text-xl font-serif font-bold text-slate-700">é»é¸ä¸‹æ–¹åœ°å€æ›´æ–°å…§å®¹</h2>
                        </div>
                        <span className="flex items-center gap-1 text-xs font-medium text-teal-800 bg-teal-100 px-3 py-1 rounded-full shadow-sm">
                          <div className="w-2 h-2 bg-teal-500 rounded-full"></div>å³æ™‚
                        </span>
                      </div>
                      
                      <div className="flex flex-wrap gap-2">
                        {TRAVEL_REGIONS.map((r) => {
                          const count = getRegionCount(r);
                          const isSelected = selectedRegionFilter === r;
                          const isFull = count >= REGION_CAPACITY;
                          return (
                            <button 
                              key={r}
                              onClick={() => setSelectedRegionFilter(r)}
                              className={`px-3 py-2 rounded-lg text-sm font-bold transition-all border ${
                                isSelected 
                                  ? 'bg-white text-teal-700 border-teal-200 shadow-md scale-105' 
                                  : 'bg-white/40 text-slate-600 border-transparent hover:bg-white/60'
                              }`}
                            >
                              {r.split(' - ')[1]} <span className={`${isFull ? 'text-rose-500' : 'text-slate-400'} ml-1`}>({count}/{REGION_CAPACITY})</span>
                            </button>
                          );
                        })}
                      </div>
                    </div>

                    <div className="overflow-y-auto max-h-[600px] flex-1 custom-scrollbar space-y-3 relative z-10">
                      {registrants.filter(r => r.region === selectedRegionFilter).length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-16 text-slate-400/70">
                          <Icons.Users className="w-12 h-12 mb-2 opacity-50" />
                          <p className="font-serif text-lg">{selectedRegionFilter}</p>
                          <p className="text-sm">ç›®å‰é‚„æ²’æœ‰äººå ±å</p>
                        </div>
                      ) : (
                        registrants
                          .filter(r => r.region === selectedRegionFilter)
                          .map((r,i)=>(
                            <div key={i} className="bg-white/70 p-4 rounded-2xl shadow-sm border border-white hover:bg-white transition group animate-fade-in" style={{animationDelay: `${i * 50}ms`}}>
                              <div className="flex justify-between items-start">
                                <div>
                                  <div className="font-bold text-slate-700 font-serif text-lg flex items-center gap-2">
                                    {r.name} 
                                    {r.totalCount > 1 && <span className="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">æ”œçœ·</span>}
                                  </div>
                                  <div className="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                    <span className="bg-blue-100/80 text-blue-700 px-2 py-0.5 rounded-md">{r.site}</span>
                                    <span>{r.timestamp}</span>
                                  </div>
                                </div>
                                <span className="bg-teal-100 text-teal-800 px-3 py-1 rounded-full font-bold text-sm shadow-sm">{r.totalCount} ä½</span>
                              </div>
                            </div>
                          ))
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }
      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
